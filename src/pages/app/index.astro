---
import { PWA } from "#app/main"
import "#app/index.css"

export let prerender = true

let requestUrl = new URL(Astro.request.url)
let siteBaseUrl = Astro.site ?? new URL(requestUrl.origin)
let canonicalUrl = new URL(
	requestUrl.pathname + requestUrl.search,
	siteBaseUrl,
).toString()
let ogImageUrl = new URL("/icons/alkalye-social.png", siteBaseUrl).toString()
let pageTitle =
	"Alkalye - beautiful Markdown Editor with E2E Encryption and Realtime Collaboration"
let metaDescription =
	"Alkalye is a beautiful markdown editor with e2e encryption and realtime collaboration. Write securely with live sync across devices."
---

<!doctype html>
<html lang="en">
	<head>
		<title>{pageTitle}</title>
		<meta charset="UTF-8" />
		<meta name="description" content={metaDescription} />
		<link rel="canonical" href={canonicalUrl} />
		<meta name="viewport" content="initial-scale=1, viewport-fit=cover, width=device-width, user-scalable=no" />
		<meta property="og:type" content="website" />
		<meta property="og:title" content="Alkalye - Beautiful Markdown Editor" />
		<meta property="og:description" content="beautiful markdown editor with e2e encryption and realtime collaboration. Write securely with live sync across devices." />
		<meta property="og:url" content={canonicalUrl} />
		<meta property="og:image" content={ogImageUrl} />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:title" content="Alkalye - Beautiful Markdown Editor" />
		<meta name="twitter:description" content="beautiful markdown editor with e2e encryption and realtime collaboration. Write securely with live sync across devices." />
		<meta name="twitter:image" content={ogImageUrl} />
		<meta name="robots" content="index, follow" />
		<meta name="keywords" content="markdown editor, e2e encrypted, end-to-end encryption, realtime collaboration, secure writing, privacy" />
		<meta name="author" content="Alkalye" />
		<meta id="theme-color" name="theme-color" content="#ffffff" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
		<meta name="apple-mobile-web-app-title" content="Alkalye" />
		<link rel="icon" type="image/png" href="/icons/alkalye-icon.png" />
		<link rel="apple-touch-icon" href="/icons/alkalye-icon.png" />
		<link rel="manifest" href="/manifest.webmanifest" />
		<link rel="preload" href="/docs/welcome.md" as="fetch" crossorigin />
	</head>
	<body class="selection:bg-brand selection:text-white">
		<div id="splash" class="bg-background fixed inset-0 z-50 flex items-center justify-center">
			<div class="text-foreground bg-background flex size-48 flex-col items-center justify-center rounded-3xl font-mono text-4xl font-bold tracking-tighter">
				Alkalye
			</div>
		</div>
		<PWA client:only="react" />
		<script>
			let appWindow = window as typeof window & {
				__pwaColdStartRedirect?: boolean
			}
			let appNavigator = window.navigator as Navigator & { standalone?: boolean }

			window.__pageLoadTime = Date.now()
			;(function () {
				let isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent)
				if (!isIOS) return
				let isStandalone =
					window.matchMedia("(display-mode: standalone)").matches ||
					appNavigator.standalone === true
				let isDeepLink = /^\/app\/(doc|spaces)\//.test(location.pathname)
				let isColdStart = !sessionStorage.getItem("pwa-session")
				if (isStandalone && isDeepLink && isColdStart) {
					appWindow.__pwaColdStartRedirect = true
				}
				if (isStandalone) {
					sessionStorage.setItem("pwa-session", "1")
				}
			})()

			function updateThemeColor() {
				let meta = document.getElementById("theme-color")
				if (!meta) return
				let bg = getComputedStyle(document.documentElement)
					.getPropertyValue("--background")
					.trim()
				meta.setAttribute("content", bg)
			}

			updateThemeColor()

			new MutationObserver(mutations => {
				for (let m of mutations) {
					if (m.type === "attributes" && m.attributeName === "class") {
						updateThemeColor()
					}
				}
			}).observe(document.documentElement, { attributes: true })
		</script>
	</body>
</html>
