# Progress Log

## 2026-01-09: Theme Schema Implementation

### What was done
- Implemented `Theme` schema in `src/schema/index.ts` with fields:
  - `version` (literal 1)
  - `name`, `author`, `description` (strings)
  - `type` (ThemeType enum: 'preview' | 'slideshow' | 'both')
  - `css` (co.plainText for large CSS content)
  - `template` (optional co.plainText for HTML templates)
  - `presets` (optional JSON string for slideshow presets)
  - `assets` (optional list of ThemeAsset)
  - `thumbnail` (optional co.image)
  - `createdAt`, `updatedAt` (dates)

- Implemented `ThemeAsset` schema for storing theme assets (fonts, images):
  - `name`, `mimeType` (strings)
  - `data` (co.fileStream for binary data)
  - `createdAt` (date)

- Implemented `ThemePreset` zod schema for slideshow color presets:
  - `name`, `appearance` (light/dark)
  - `colors` object with background, foreground, accent, and optional heading, link, codeBackground
  - Optional `fonts` object with title and body font families

- Added `themes: co.optional(co.list(Theme))` to `UserRoot` schema

- Added migration in `UserAccount.withMigration()` to initialize empty themes list for new and existing users

### PRD requirements completed
- [x] schema: "Theme schema stores uploaded theme data" - passes: true
- [x] schema: "Theme references stored as co.plainText for CSS content" - passes: true

### Notes for next steps
- The schema is now ready for the upload functionality
- Next priority should be implementing the Settings UI for theme upload and management
- The `ThemeType` enum and `ThemePreset` zod schema are exported for use in upload validation

## 2026-01-09: Theme Upload and Settings UI

### What was done
- Created `src/lib/theme-upload.ts` for parsing and validating theme zip files:
  - `parseThemeZip(file)` - parses a zip file and extracts all theme content
  - `validateThemeJson(content)` - validates theme.json manifest against schema
  - `ThemeJsonSchema` - zod schema for theme.json validation
  - Handles: theme.json manifest, CSS files, HTML templates, presets.json, fonts, thumbnails
  - Returns typed `ThemeUploadError` for different error conditions

- Added `ThemesSection` component to `src/routes/settings.tsx`:
  - Upload button with file input for .zip files
  - Loading state during upload
  - Error display with detailed validation errors
  - Empty state when no themes uploaded
  - List of uploaded themes showing name, type, and author
  - Delete button with confirmation dialog

- Updated settings query to include themes with CSS and assets loaded

### Files changed
- `src/lib/theme-upload.ts` (new file)
- `src/routes/settings.tsx` (added ThemesSection, updated imports and query)

### PRD requirements completed
- [x] upload: "Users can upload theme zip files in settings" - passes: true
- [x] upload: "Theme zip validation on upload" - passes: true
- [x] upload: "Theme assets are extracted and stored" - passes: true
- [x] settings: "Themes list displayed in settings" - passes: true
- [x] settings: "Theme can be deleted from settings" - passes: true

### Notes for next steps
- "Theme can be set as default" not implemented yet - requires adding default theme fields to Settings
- Thumbnail display in theme list not implemented yet (stored but not shown)
- Next priority: implement frontmatter parsing to apply themes to documents
- CSS asset URL rewriting (for fonts in CSS) will be needed when applying themes

## 2026-01-09: Frontmatter Theme Parsing

### What was done
- Created `src/lib/document-theme.ts` with utilities for parsing and resolving themes from frontmatter:
  - `getThemeName(content)` - extracts theme name from frontmatter `theme:` field
  - `getPresetName(content)` - extracts preset name from frontmatter `preset:` field
  - `findThemeByName(themes, name)` - case-insensitive theme lookup in user's themes list
  - `getThemePresets(theme)` - parses presets JSON from theme
  - `findPresetByName(theme, name)` - case-insensitive preset lookup within a theme
  - `useDocumentTheme(content)` - React hook that resolves theme and preset from document content

- The `useDocumentTheme` hook:
  - Returns `{ theme, preset, warning }` based on frontmatter
  - Handles case-insensitive theme name matching
  - Shows warning when theme is not found in user's themes list
  - Falls back to first preset when specified preset is not found
  - Skips `light`/`dark` values (handled by appearance system)
  - Loads themes with CSS and assets for rendering

### Files changed
- `src/lib/document-theme.ts` (new file)

### PRD requirements completed
- [x] frontmatter: "Theme can be specified in document frontmatter" - passes: true
- [x] frontmatter: "Preset can be specified for slideshow themes" - passes: true

### Notes for next steps
- The hook is ready to use in Preview and Slideshow components
- Next priority: integrate `useDocumentTheme` into Preview component to inject CSS
- Warning UI for missing themes should be added to preview/slideshow views
- CSS asset URL rewriting still needed for fonts/images referenced in theme CSS

## 2026-01-09: Preview Theme CSS Injection

### What was done
- Created `src/lib/theme-renderer.ts` with utilities for building theme CSS:
  - `buildThemeStyles(theme, preset)` - builds complete CSS including @font-face rules and preset variables
  - Creates blob URLs from theme font assets (co.fileStream)
  - Returns `ThemeStyles` object with css, fontFaceRules, presetVariables, and blobUrls
  - Properly handles cleanup of blob URLs when theme changes

- Integrated theme styles into `src/components/preview.tsx`:
  - Added `useDocumentTheme` hook to resolve theme from frontmatter
  - Added `useThemeStyles` custom hook that manages theme CSS and blob URL lifecycle
  - Injects theme CSS via `<style>` tag in preview
  - Injects @font-face rules for theme fonts with blob URLs
  - Injects preset CSS variables (--preset-background, --preset-foreground, etc.)
  - Shows warning banner when theme is not found in user's themes
  - Added `data-theme` attribute to article for theme-specific CSS targeting

- Theme CSS features:
  - Font assets are served via blob URLs created from Jazz fileStream
  - @font-face rules are generated automatically with correct format (woff2, woff, truetype, opentype)
  - font-display: swap for progressive font loading
  - Preset colors exposed as CSS variables for theme authors to use

### Files changed
- `src/lib/theme-renderer.ts` (new file)
- `src/components/preview.tsx` (added theme integration)

### PRD requirements completed
- [x] preview: "Preview component applies theme CSS" - passes: true
- [x] preview: "Preview loads theme fonts" - passes: true

### Notes for next steps
- "Preview uses custom HTML template when provided" not yet implemented
- Next priority could be: slideshow theme support, or custom HTML templates
- The same pattern (useDocumentTheme + buildThemeStyles) can be used for slideshow
