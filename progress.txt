# Progress Log

## 2026-01-10: Slideshow Text Wrapping

**Feature:** slideshow-scaling (3 user stories)

**Changes:**
- Fixed text wrapping: content now wraps at container width instead of scaling to tiny size
- Added `max-w-full` and `overflow-wrap: break-word` to slide blocks for proper text wrapping
- Changed measurement to use width constraint so text wraps before scaling kicks in
- Scaling now only reduces size when wrapped content height exceeds viewport
- Fixed lint errors: refactored `useThemeStyles` hook to use "adjust state during render" pattern instead of synchronous setState in effects

**Files modified:**
- src/components/slideshow.tsx
- src/components/preview.tsx

**Notes for next dev:**
- Theming infrastructure is already in place (useDocumentTheme, theme-renderer, CSS injection)
- The slideshow theming stories should be next priority
- Pre-existing test failures in documents.test.ts and spaces.test.ts (Jazz sync issues) are unrelated

---

## 2026-01-10: Slideshow Semantic HTML

**Feature:** slideshow-semantic-html (3 user stories)

**Changes:**
- Wrapped slideshow content in `<article>` element with `data-theme` attribute
- Changed headings from `<div>` to proper `<h1>`-`<h6>` elements based on depth
- Changed paragraph text from `<div>` to `<p>` elements

**Files modified:**
- src/components/slideshow.tsx

**Notes for next dev:**
- This enables CSS selectors like `[data-theme="ThemeName"] h1` to work
- The slideshow theming stories should now be unblocked
- Pre-existing test failures in documents.test.ts and spaces.test.ts (Jazz sync issues) are unrelated

---

## 2026-01-10: Slideshow Theme CSS Support

**Feature:** slideshow-theming (5 user stories)

**Changes:**
- Removed hardcoded Tailwind color classes from slideshow elements to allow theme CSS to apply
- Links: removed `text-brand`, now use `var(--preset-link, var(--preset-accent, currentColor))`
- Inline code: removed `bg-muted`, now use `var(--preset-code-background, rgba(127,127,127,0.15))`
- Blockquotes: removed `border-brand`, now use `var(--preset-accent, currentColor)`
- Code blocks fallback: removed `bg-muted`/`text-foreground`, now use CSS vars
- Image placeholder: removed `bg-muted`/`text-muted-foreground`, now use CSS vars

**Files modified:**
- src/components/slideshow.tsx

**Notes for next dev:**
- Theme CSS now applies via `[data-theme] h1`, `[data-theme] p`, etc selectors
- Preset colors (background, foreground, accent, etc) are injected as CSS variables
- Next priority: slideshow-theming preset colors stories (lines 128-164 in PRD)
- Pre-existing test failures in documents.test.ts/spaces.test.ts are unrelated (Jazz sync issues)

---

## 2026-01-10: Slideshow Preset Colors (Verification)

**Feature:** slideshow-theming preset colors (3 user stories)

**Status:** Already implemented - marked PRD as passing

**Implementation locations:**
- `src/components/slideshow.tsx:167-174` - applies `var(--preset-background)` and `var(--preset-foreground)` to main container
- `src/components/slideshow.tsx:561` - links use `var(--preset-link, var(--preset-accent, currentColor))`
- `src/components/slideshow.tsx:689` - blockquotes use `var(--preset-accent, currentColor)` for border
- `src/lib/theme-renderer.ts:364-400` - `buildPresetVariables()` generates `:root { --preset-* }` CSS variables
- `src/lib/document-theme.ts:276-286` - `useDocumentTheme` auto-selects preset by appearance (light/dark)

**How it works:**
1. User creates theme with light/dark presets in presets.json
2. `useDocumentTheme` resolves theme + auto-selects preset based on system appearance
3. `buildPresetVariables()` injects preset colors as CSS variables: `--preset-background`, `--preset-foreground`, `--preset-accent`, etc.
4. Slideshow applies these via inline styles and CSS var references

**Notes for next dev:**
- Next priority: slideshow-presets stories (auto-selecting light/dark presets)
- Pre-existing test failures in documents.test.ts/spaces.test.ts are unrelated (Jazz sync issues)

---

## 2026-01-10: Slideshow Preset Auto-Selection

**Feature:** slideshow-presets (3 user stories)

**Changes:**
- Fixed `useDocumentTheme` to fall through to default theme when frontmatter has appearance-only value (`theme: light` or `theme: dark`)
- Previously, `theme: dark` would skip default theme lookup and return null
- Now, appearance values are detected and the hook continues to check for default theme in settings
- Warning message no longer fires for appearance-only values when no default is set

**Files modified:**
- src/lib/document-theme.ts

**How it works:**
1. User writes `theme: dark` in frontmatter (appearance override)
2. `parsePresentationTheme()` extracts this as appearance value
3. `useDocumentTheme()` detects "dark" is an appearance-only value (not a theme name)
4. Hook falls through to load default slideshow theme from settings
5. The dark appearance passed to hook causes dark preset to be selected

**Notes for next dev:**
- Next priority: preview-css-loading or preview-theming stories
- Pre-existing test failures in documents.test.ts/spaces.test.ts are unrelated (Jazz sync issues)

---

## 2026-01-10: Preview Theming Support

**Feature:** preview-css-loading (3 stories) + preview-theming (7 stories) = 10 user stories

**Changes:**
- Fixed preview to pass system appearance to `useDocumentTheme` for preset auto-selection
- Previously preview called `useDocumentTheme(content, "preview")` without appearance
- Now calls `useDocumentTheme(content, "preview", resolvedTheme)` matching slideshow behavior

**Files modified:**
- src/components/preview.tsx:39

**How it works:**
1. Preview already had `useResolvedTheme()` to get system light/dark mode
2. Now passes this to `useDocumentTheme` as third argument
3. Theme presets are auto-selected by appearance (light/dark) just like slideshow
4. CSS, fonts, and preset variables are injected via `<style>` tag

**Implementation already in place (verified):**
- `preview.tsx:87-88` - `useThemeStyles(documentTheme)` loads CSS async
- `preview.tsx:139-149` - combines fontFaceRules + presetVariables + css
- `preview.tsx:189` - injects via `<style>{injectedStyles}</style>`
- `preview.tsx:211,219` - `data-theme` attribute on containers
- `preview.tsx:152-174` - template rendering with `tryRenderTemplateWithContent`

**Notes for next dev:**
- Next priority: theme-presets, theme-upload, or theme-defaults stories
- Pre-existing test failures in documents.test.ts/spaces.test.ts are unrelated (Jazz sync issues)

---

## 2026-01-10: Theme Presets Verification

**Feature:** theme-presets (3 user stories)

**Status:** Already implemented - marked PRD as passing

**Implementation locations:**
- `src/lib/theme-renderer.ts:364-400` - `buildPresetVariables()` generates CSS vars:
  - `--preset-background`, `--preset-foreground`, `--preset-accent` (core colors)
  - `--preset-accent-1` through `--preset-accent-6` (accent palette)
  - `--preset-heading`, `--preset-link`, `--preset-code-background` (optional colors)
  - `--preset-font-title`, `--preset-font-body` (fonts)
  - `--preset-appearance` (light/dark indicator)
- `src/lib/document-theme.ts:275-284` - `findPresetByAppearance()` auto-selects light/dark preset
- `src/components/preview.tsx:144` - injects `themeStyles.presetVariables`
- `src/components/slideshow.tsx:136` - injects `themeStyles.presetVariables`

**How preset auto-selection works:**
1. Theme has 2 presets: one with `appearance: "light"`, one with `appearance: "dark"`
2. `useDocumentTheme()` receives system appearance from `useResolvedTheme()`
3. `findPresetByAppearance()` returns matching preset
4. `buildPresetVariables()` generates `:root { --preset-* }` CSS from selected preset
5. Preview/slideshow inject variables via `<style>` tag

**Notes for next dev:**
- Next priority: theme-upload, theme-defaults, or error-handling stories
- Pre-existing test failures in documents.test.ts/spaces.test.ts are unrelated (Jazz sync issues)

---

## 2026-01-10: Theme Upload Tests

**Feature:** theme-upload (5 user stories)

**Status:** Implementation already existed - added comprehensive unit tests to verify

**Changes:**
- Created `src/lib/theme-upload.test.ts` with 30 tests covering:
  - `validateThemeJson` validation (8 tests)
  - Basic zip parsing (4 tests)
  - CSS handling including sanitization (2 tests)
  - Presets parsing and validation (5 tests)
  - Font extraction (3 tests)
  - HTML template parsing and sanitization (3 tests)
  - Thumbnail extraction (2 tests)
  - Error message helpfulness (3 tests)

**Files modified:**
- src/lib/theme-upload.test.ts (new)

**Implementation locations (pre-existing):**
- `src/lib/theme-upload.ts` - `parseThemeZip()` parses zip, validates theme.json, extracts CSS/presets/fonts
- `src/routes/settings.tsx:298-538` - ThemesSection UI with upload handler
- Theme schema in `src/schema/index.ts:92-105`

**Notes for next dev:**
- Next priority: theme-defaults or error-handling stories
- Pre-existing test failures in documents.test.ts/spaces.test.ts are unrelated (Jazz sync issues)

---

## 2026-01-10: Theme Defaults Verification

**Feature:** theme-defaults (3 user stories)

**Status:** Implementation already existed - added unit tests to verify and document behavior

**Changes:**
- Created `src/lib/document-theme.test.ts` with 18 tests covering:
  - `getThemeName` parsing (7 tests) - extracts theme from frontmatter
  - `getPresetName` parsing (3 tests) - extracts preset from frontmatter
  - `findThemeByName` lookup (6 tests) - case-insensitive theme search
  - Documented default theme behavior in test comments

**Files modified:**
- src/lib/document-theme.test.ts (new)

**Implementation locations (pre-existing):**
- `src/lib/document-theme.ts:188-202` - fallback to default theme when no frontmatter
- `src/routes/settings.tsx:541-647` - DefaultThemeSettings UI (dropdowns for preview/slideshow defaults)
- `src/schema/index.ts:52-56` - Settings schema with `defaultPreviewTheme`/`defaultSlideshowTheme`

**How default themes work:**
1. User uploads theme and sets as default in Settings > Themes > Default Themes
2. Settings stores theme name in `defaultPreviewTheme` or `defaultSlideshowTheme`
3. `useDocumentTheme(content, mode)` checks frontmatter first
4. If no frontmatter theme (or theme is "light"/"dark" appearance value), falls back to settings default
5. Frontmatter theme always overrides default theme

**Notes for next dev:**
- Next priority: theme-css-selectors or error-handling stories
- Pre-existing test failures: documents.test.ts/spaces.test.ts (Jazz sync), theme-sanitize.test.ts (HTML sanitization)

---

## 2026-01-10: Theme CSS Selector Pattern Fix

**Feature:** theme-css-selectors (3 user stories)

**Changes:**
- Moved `data-theme` attribute from `<article>` to parent `<div>` in preview component
- This enables theme CSS to use `[data-theme="Name"] article h1` pattern for preview
- Slideshow already had correct structure: `<article data-theme="Name">` allows `[data-theme] h1` selectors

**Files modified:**
- src/components/preview.tsx

**Selector patterns now supported:**
- **Preview:** `[data-theme="Name"] article h1` - the article is a child of the themed container
- **Slideshow:** `[data-theme="Name"] h1` - h1 is inside the themed article element
- **Both modes:** Themes with `type: both` can include both selector patterns in their CSS

**DOM structure:**
- Preview: `<div data-theme="Name"><article class="prose">...</article></div>`
- Slideshow: `<article data-theme="Name">...</article>`

**Notes for next dev:**
- Next priority: kitchen-sink files, example-themes, theming-guide, or error-handling
- Pre-existing test failures: documents.test.ts/spaces.test.ts (Jazz sync issues)
